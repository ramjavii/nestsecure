# =============================================================================
# NESTSECURE - Modelo de Vulnerability
# =============================================================================
"""
Modelo SQLAlchemy para vulnerabilidades detectadas.

Una vulnerabilidad representa un problema de seguridad encontrado en un asset
o servicio durante un escaneo. Puede estar correlacionada con un CVE del NVD.
"""

from datetime import datetime, timezone
from enum import Enum
from typing import TYPE_CHECKING, Optional
from uuid import uuid4

from sqlalchemy import (
    Boolean,
    DateTime,
    Float,
    ForeignKey,
    Integer,
    String,
    Text,
)
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.db.base import Base, TimestampMixin, UUID, JSONB, StringArray

if TYPE_CHECKING:
    from app.models.asset import Asset
    from app.models.cve_cache import CVECache
    from app.models.organization import Organization
    from app.models.scan import Scan
    from app.models.service import Service
    from app.models.user import User
    from app.models.vulnerability_comment import VulnerabilityComment


class VulnerabilitySeverity(str, Enum):
    """Niveles de severidad de vulnerabilidad."""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class VulnerabilityStatus(str, Enum):
    """Estados de gestión de vulnerabilidad."""
    OPEN = "open"                    # Nueva, sin acción
    ACKNOWLEDGED = "acknowledged"    # Reconocida, pendiente de acción
    IN_PROGRESS = "in_progress"      # En proceso de remediación
    FIXED = "fixed"                  # Corregida
    FALSE_POSITIVE = "false_positive"  # Marcada como falso positivo
    ACCEPTED_RISK = "accepted_risk"  # Riesgo aceptado


class Vulnerability(Base, TimestampMixin):
    """
    Modelo de Vulnerability.
    
    Representa una vulnerabilidad detectada en un asset o servicio.
    
    Attributes:
        id: UUID único de la vulnerabilidad
        organization_id: FK a la organización propietaria
        asset_id: FK al asset donde se detectó
        service_id: FK al servicio afectado (opcional)
        scan_id: FK al scan que la detectó
        cve_id: ID del CVE asociado (opcional)
        name: Nombre descriptivo de la vulnerabilidad
        severity: Nivel de severidad (critical, high, medium, low, info)
        status: Estado de gestión (open, fixed, etc.)
        cvss_score: Puntuación CVSS (0.0-10.0)
        risk_score: Puntuación de riesgo calculada (0.0-100.0)
    """
    
    __tablename__ = "vulnerabilities"
    
    # -------------------------------------------------------------------------
    # Campos principales
    # -------------------------------------------------------------------------
    id: Mapped[str] = mapped_column(
        UUID(),
        primary_key=True,
        default=lambda: str(uuid4()).replace("-", ""),
    )
    
    organization_id: Mapped[str] = mapped_column(
        UUID(),
        ForeignKey("organizations.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    
    # -------------------------------------------------------------------------
    # Relaciones con Asset, Service, Scan
    # -------------------------------------------------------------------------
    asset_id: Mapped[str] = mapped_column(
        UUID(),
        ForeignKey("assets.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    
    service_id: Mapped[Optional[str]] = mapped_column(
        UUID(),
        ForeignKey("services.id", ondelete="SET NULL"),
        nullable=True,
        index=True,
    )
    
    scan_id: Mapped[str] = mapped_column(
        UUID(),
        ForeignKey("scans.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    
    # Referencia al CVE (si existe)
    # NOTE: cve_id is stored as a string without FK constraint to allow
    # storing CVEs that haven't been synced to cve_cache yet.
    cve_id: Mapped[Optional[str]] = mapped_column(
        String(20),
        nullable=True,
        index=True,
    )
    
    # -------------------------------------------------------------------------
    # Información de la vulnerabilidad
    # -------------------------------------------------------------------------
    name: Mapped[str] = mapped_column(
        String(500),
        nullable=False,
    )
    
    description: Mapped[str] = mapped_column(
        Text,
        nullable=False,
    )
    
    # Host y puerto (desnormalizados para queries rápidos)
    host: Mapped[Optional[str]] = mapped_column(
        String(255),
        nullable=True,
    )
    
    port: Mapped[Optional[int]] = mapped_column(
        Integer,
        nullable=True,
    )
    
    solution: Mapped[Optional[str]] = mapped_column(
        Text,
        nullable=True,
    )
    
    # URLs de referencia
    references: Mapped[list[str]] = mapped_column(
        StringArray(),
        nullable=True,
        default=list,
    )
    
    # -------------------------------------------------------------------------
    # Clasificación (CWE)
    # -------------------------------------------------------------------------
    cwe_id: Mapped[Optional[str]] = mapped_column(
        String(20),
        nullable=True,
    )
    
    cwe_name: Mapped[Optional[str]] = mapped_column(
        String(255),
        nullable=True,
    )
    
    # -------------------------------------------------------------------------
    # CVSS Scoring
    # -------------------------------------------------------------------------
    cvss_score: Mapped[Optional[float]] = mapped_column(
        Float,
        nullable=True,
        index=True,
    )
    
    cvss_vector: Mapped[Optional[str]] = mapped_column(
        String(200),
        nullable=True,
    )
    
    severity: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        default=VulnerabilitySeverity.MEDIUM.value,
        index=True,
    )
    
    # -------------------------------------------------------------------------
    # Risk Scoring (calculado)
    # -------------------------------------------------------------------------
    risk_score: Mapped[Optional[float]] = mapped_column(
        Float,
        nullable=True,
        index=True,
    )
    
    risk_factors: Mapped[Optional[dict]] = mapped_column(
        JSONB(),
        nullable=True,
    )
    
    # -------------------------------------------------------------------------
    # Información de exploits
    # -------------------------------------------------------------------------
    exploit_available: Mapped[bool] = mapped_column(
        Boolean,
        nullable=False,
        default=False,
        index=True,
    )
    
    exploit_maturity: Mapped[Optional[str]] = mapped_column(
        String(50),
        nullable=True,
    )
    
    in_the_wild: Mapped[bool] = mapped_column(
        Boolean,
        nullable=False,
        default=False,
    )
    
    # -------------------------------------------------------------------------
    # Gestión de la vulnerabilidad
    # -------------------------------------------------------------------------
    status: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        default=VulnerabilityStatus.OPEN.value,
        index=True,
    )
    
    assigned_to_id: Mapped[Optional[str]] = mapped_column(
        UUID(),
        ForeignKey("users.id", ondelete="SET NULL"),
        nullable=True,
    )
    
    due_date: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
    )
    
    resolution_notes: Mapped[Optional[str]] = mapped_column(
        Text,
        nullable=True,
    )
    
    resolved_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
    )
    
    resolved_by_id: Mapped[Optional[str]] = mapped_column(
        UUID(),
        ForeignKey("users.id", ondelete="SET NULL"),
        nullable=True,
    )
    
    # -------------------------------------------------------------------------
    # Tracking de detecciones
    # -------------------------------------------------------------------------
    first_detected_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        nullable=False,
        default=lambda: datetime.now(timezone.utc),
    )
    
    last_detected_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        nullable=False,
        default=lambda: datetime.now(timezone.utc),
    )
    
    times_detected: Mapped[int] = mapped_column(
        Integer,
        nullable=False,
        default=1,
    )
    
    # -------------------------------------------------------------------------
    # Metadata del scanner
    # -------------------------------------------------------------------------
    scanner_name: Mapped[Optional[str]] = mapped_column(
        String(100),
        nullable=True,
    )
    
    scanner_plugin_id: Mapped[Optional[str]] = mapped_column(
        String(100),
        nullable=True,
    )
    
    # Output raw del scanner
    raw_output: Mapped[Optional[dict]] = mapped_column(
        JSONB(),
        nullable=True,
    )
    
    # Evidencia (screenshots, logs, etc.)
    evidence: Mapped[Optional[dict]] = mapped_column(
        JSONB(),
        nullable=True,
    )
    
    # -------------------------------------------------------------------------
    # Relaciones
    # -------------------------------------------------------------------------
    organization: Mapped["Organization"] = relationship(
        "Organization",
        back_populates="vulnerabilities",
    )
    
    asset: Mapped["Asset"] = relationship(
        "Asset",
        back_populates="vulnerabilities",
    )
    
    service: Mapped[Optional["Service"]] = relationship(
        "Service",
        back_populates="vulnerabilities",
    )
    
    scan: Mapped["Scan"] = relationship(
        "Scan",
        back_populates="vulnerabilities",
    )
    
    # NOTE: cve relationship requires explicit join since we removed the FK constraint
    # to allow storing CVE IDs that haven't been synced to cve_cache yet.
    # The relationship is lazy-loaded and optional.
    cve: Mapped[Optional["CVECache"]] = relationship(
        "CVECache",
        primaryjoin="foreign(Vulnerability.cve_id) == CVECache.cve_id",
        lazy="select",
        viewonly=True,
    )
    
    assigned_to: Mapped[Optional["User"]] = relationship(
        "User",
        foreign_keys=[assigned_to_id],
    )
    
    resolved_by: Mapped[Optional["User"]] = relationship(
        "User",
        foreign_keys=[resolved_by_id],
    )
    
    comments: Mapped[list["VulnerabilityComment"]] = relationship(
        "VulnerabilityComment",
        back_populates="vulnerability",
        cascade="all, delete-orphan",
    )
    
    # -------------------------------------------------------------------------
    # Métodos de utilidad
    # -------------------------------------------------------------------------
    @property
    def severity_class(self) -> str:
        """Retorna la clase de severidad (critical, high, medium, low, info)."""
        if self.cvss_score is not None:
            if self.cvss_score >= 9.0:
                return "critical"
            elif self.cvss_score >= 7.0:
                return "high"
            elif self.cvss_score >= 4.0:
                return "medium"
            elif self.cvss_score > 0:
                return "low"
            else:
                return "info"
        return self.severity or "medium"
    
    @property
    def cve_ids(self) -> list[str]:
        """Retorna lista de CVE IDs asociados."""
        if self.cve_id:
            return [self.cve_id]
        return []
    
    @property
    def is_overdue(self) -> bool:
        """Indica si la vulnerabilidad está vencida."""
        if self.due_date and self.status not in [
            VulnerabilityStatus.FIXED.value,
            VulnerabilityStatus.FALSE_POSITIVE.value,
            VulnerabilityStatus.ACCEPTED_RISK.value,
        ]:
            return datetime.now(timezone.utc) > self.due_date
        return False
    
    @property
    def is_resolved(self) -> bool:
        """Indica si la vulnerabilidad está resuelta."""
        return self.status in [
            VulnerabilityStatus.FIXED.value,
            VulnerabilityStatus.FALSE_POSITIVE.value,
            VulnerabilityStatus.ACCEPTED_RISK.value,
        ]
    
    def mark_as_fixed(self, user_id: str, notes: Optional[str] = None) -> None:
        """Marca la vulnerabilidad como corregida."""
        self.status = VulnerabilityStatus.FIXED.value
        self.resolved_at = datetime.now(timezone.utc)
        self.resolved_by_id = user_id
        if notes:
            self.resolution_notes = notes
    
    def mark_as_false_positive(self, user_id: str, notes: Optional[str] = None) -> None:
        """Marca la vulnerabilidad como falso positivo."""
        self.status = VulnerabilityStatus.FALSE_POSITIVE.value
        self.resolved_at = datetime.now(timezone.utc)
        self.resolved_by_id = user_id
        if notes:
            self.resolution_notes = notes
    
    def accept_risk(self, user_id: str, notes: Optional[str] = None) -> None:
        """Acepta el riesgo de la vulnerabilidad."""
        self.status = VulnerabilityStatus.ACCEPTED_RISK.value
        self.resolved_at = datetime.now(timezone.utc)
        self.resolved_by_id = user_id
        if notes:
            self.resolution_notes = notes
    
    def reopen(self) -> None:
        """Reabre la vulnerabilidad."""
        self.status = VulnerabilityStatus.OPEN.value
        self.resolved_at = None
        self.resolved_by_id = None
        self.times_detected += 1
        self.last_detected_at = datetime.now(timezone.utc)
    
    def assign_to(self, user_id: str, due_date: Optional[datetime] = None) -> None:
        """Asigna la vulnerabilidad a un usuario."""
        self.assigned_to_id = user_id
        self.status = VulnerabilityStatus.IN_PROGRESS.value
        if due_date:
            self.due_date = due_date
    
    def enrich_from_cve(self, cve: "CVECache") -> None:
        """
        Enriquece la vulnerabilidad con datos del CVE.
        
        Args:
            cve: Objeto CVECache con información del CVE
        """
        if cve.cvss_v3_score and not self.cvss_score:
            self.cvss_score = cve.cvss_v3_score
            self.cvss_vector = cve.cvss_v3_vector
        
        if cve.cvss_v3_severity:
            self.severity = cve.cvss_v3_severity.lower()
        
        if cve.exploit_available:
            self.exploit_available = True
        
        if cve.in_cisa_kev:
            self.in_the_wild = True
        
        if cve.cwe_ids:
            self.cwe_id = cve.cwe_ids[0] if cve.cwe_ids else None
