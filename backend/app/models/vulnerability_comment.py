# =============================================================================
# NESTSECURE - Modelo de Vulnerability Comment
# =============================================================================
"""
Modelo SQLAlchemy para comentarios en vulnerabilidades.

Permite a los usuarios añadir notas, discusiones y actualizaciones
sobre el estado de las vulnerabilidades.
"""

from datetime import datetime, timezone
from typing import TYPE_CHECKING, Optional
from uuid import uuid4

from sqlalchemy import (
    DateTime,
    ForeignKey,
    String,
    Text,
)
from sqlalchemy.orm import Mapped, mapped_column, relationship

from app.db.base import Base, TimestampMixin, UUID, JSONB

if TYPE_CHECKING:
    from app.models.user import User
    from app.models.vulnerability import Vulnerability


class VulnerabilityComment(Base, TimestampMixin):
    """
    Modelo de VulnerabilityComment.
    
    Representa un comentario o nota añadida a una vulnerabilidad.
    
    Attributes:
        id: UUID único del comentario
        vulnerability_id: FK a la vulnerabilidad
        user_id: FK al usuario que creó el comentario
        content: Contenido del comentario
    """
    
    __tablename__ = "vulnerability_comments"
    
    # -------------------------------------------------------------------------
    # Campos principales
    # -------------------------------------------------------------------------
    id: Mapped[str] = mapped_column(
        UUID(),
        primary_key=True,
        default=lambda: str(uuid4()).replace("-", ""),
    )
    
    vulnerability_id: Mapped[str] = mapped_column(
        UUID(),
        ForeignKey("vulnerabilities.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    
    user_id: Mapped[str] = mapped_column(
        UUID(),
        ForeignKey("users.id", ondelete="CASCADE"),
        nullable=False,
        index=True,
    )
    
    # -------------------------------------------------------------------------
    # Contenido
    # -------------------------------------------------------------------------
    content: Mapped[str] = mapped_column(
        Text,
        nullable=False,
    )
    
    # Tipo de comentario (nota, status_change, assignment, etc.)
    comment_type: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        default="note",
    )
    
    # Metadata adicional (ej: estado anterior/nuevo si es status_change)
    extra_data: Mapped[Optional[dict]] = mapped_column(
        JSONB(),
        nullable=True,
    )
    
    # -------------------------------------------------------------------------
    # Edición
    # -------------------------------------------------------------------------
    edited_at: Mapped[Optional[datetime]] = mapped_column(
        DateTime(timezone=True),
        nullable=True,
    )
    
    # -------------------------------------------------------------------------
    # Relaciones
    # -------------------------------------------------------------------------
    vulnerability: Mapped["Vulnerability"] = relationship(
        "Vulnerability",
        back_populates="comments",
    )
    
    user: Mapped["User"] = relationship(
        "User",
    )
    
    # -------------------------------------------------------------------------
    # Métodos
    # -------------------------------------------------------------------------
    def edit(self, new_content: str) -> None:
        """Edita el contenido del comentario."""
        self.content = new_content
        self.edited_at = datetime.now(timezone.utc)
    
    @property
    def is_edited(self) -> bool:
        """Indica si el comentario ha sido editado."""
        return self.edited_at is not None
