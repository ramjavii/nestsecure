# =============================================================================
# NESTSECURE - Schemas de Vulnerability
# =============================================================================
"""
Schemas Pydantic para operaciones CRUD de Vulnerabilities.

Incluye validación de datos para:
- Creación de vulnerabilidades (desde scanners)
- Lectura de vulnerabilidades
- Actualización de estado y asignación
- Filtros y búsquedas
"""

from datetime import datetime
from typing import TYPE_CHECKING, Any, Optional

from pydantic import Field

from app.schemas.common import BaseSchema, IDSchema, TimestampSchema

if TYPE_CHECKING:
    pass


# =============================================================================
# Enums como literales para validación
# =============================================================================
SEVERITY_LEVELS = ["critical", "high", "medium", "low", "info"]
VULNERABILITY_STATUSES = [
    "open", "acknowledged", "in_progress", 
    "fixed", "false_positive", "accepted_risk"
]


# =============================================================================
# Vulnerability Schemas
# =============================================================================
class VulnerabilityBase(BaseSchema):
    """Campos base de una vulnerabilidad."""
    
    name: str = Field(..., min_length=1, max_length=500, description="Nombre de la vulnerabilidad")
    severity: str = Field(..., description="Nivel de severidad")


class VulnerabilityCreate(VulnerabilityBase):
    """
    Schema para crear una vulnerabilidad (usado por scanners).
    
    Ejemplo:
        {
            "name": "SQL Injection in Login Form",
            "description": "Vulnerabilidad de inyección SQL...",
            "severity": "high",
            "asset_id": "uuid-del-asset",
            "scan_id": "uuid-del-scan",
            "cvss_score": 8.5
        }
    """
    
    description: str = Field(..., min_length=1)
    asset_id: str = Field(..., description="ID del asset afectado")
    service_id: Optional[str] = Field(None, description="ID del servicio afectado")
    scan_id: str = Field(..., description="ID del scan que detectó la vulnerabilidad")
    cve_id: Optional[str] = Field(
        None, 
        pattern=r"^CVE-\d{4}-\d{4,}$",
        description="ID del CVE asociado (ej: CVE-2024-1234)"
    )
    
    # Detalles
    solution: Optional[str] = Field(None, max_length=5000)
    references: Optional[list[str]] = Field(default_factory=list)
    cwe_id: Optional[str] = Field(None, max_length=20)
    cwe_name: Optional[str] = Field(None, max_length=255)
    
    # CVSS
    cvss_score: Optional[float] = Field(None, ge=0.0, le=10.0)
    cvss_vector: Optional[str] = Field(None, max_length=200)
    
    # Exploit info
    exploit_available: bool = Field(default=False)
    exploit_maturity: Optional[str] = Field(None, max_length=50)
    in_the_wild: bool = Field(default=False)
    
    # Scanner metadata
    scanner_name: Optional[str] = Field(None, max_length=100)
    scanner_plugin_id: Optional[str] = Field(None, max_length=100)
    raw_output: Optional[dict] = None
    evidence: Optional[dict] = None


class VulnerabilityUpdate(BaseSchema):
    """
    Schema para actualizar una vulnerabilidad.
    
    Solo permite actualizar campos de gestión, no los datos detectados.
    """
    
    status: Optional[str] = Field(None, description="Nuevo estado")
    assigned_to_id: Optional[str] = Field(None, description="ID del usuario asignado")
    due_date: Optional[datetime] = Field(None, description="Fecha límite de remediación")
    resolution_notes: Optional[str] = Field(None, max_length=5000)


class VulnerabilityRead(VulnerabilityBase, IDSchema, TimestampSchema):
    """
    Schema para leer una vulnerabilidad.
    
    Incluye todos los campos públicos.
    """
    
    organization_id: str
    asset_id: str
    service_id: Optional[str]
    scan_id: str
    cve_id: Optional[str]
    
    description: str
    solution: Optional[str]
    references: Optional[list[str]]
    
    # Clasificación
    cwe_id: Optional[str]
    cwe_name: Optional[str]
    
    # CVSS
    cvss_score: Optional[float]
    cvss_vector: Optional[str]
    
    # Risk
    risk_score: Optional[float]
    risk_factors: Optional[dict]
    
    # Exploit
    exploit_available: bool
    exploit_maturity: Optional[str]
    in_the_wild: bool
    
    # Gestión
    status: str
    assigned_to_id: Optional[str]
    due_date: Optional[datetime]
    resolution_notes: Optional[str]
    resolved_at: Optional[datetime]
    resolved_by_id: Optional[str]
    
    # Tracking
    first_detected_at: datetime
    last_detected_at: datetime
    times_detected: int
    
    # Scanner
    scanner_name: Optional[str]


class VulnerabilityReadMinimal(IDSchema):
    """Schema mínimo para listas y referencias."""
    
    name: str
    severity: str
    status: str
    cvss_score: Optional[float]
    cve_id: Optional[str]
    first_detected_at: datetime


class VulnerabilityReadWithAsset(VulnerabilityRead):
    """Vulnerabilidad con información del asset incluida."""
    
    asset: Optional[Any] = None  # AssetReadMinimal


class VulnerabilityReadWithDetails(VulnerabilityRead):
    """Vulnerabilidad con todos los detalles relacionados."""
    
    asset: Optional[Any] = None  # AssetReadMinimal
    service: Optional[Any] = None  # ServiceReadMinimal
    scan: Optional[Any] = None  # ScanReadMinimal


class VulnerabilityStats(BaseSchema):
    """Estadísticas de vulnerabilidades."""
    
    total: int
    by_severity: dict = Field(
        default_factory=dict,
        description="Conteo por severidad: {critical: 5, high: 10, ...}"
    )
    by_status: dict = Field(
        default_factory=dict,
        description="Conteo por estado: {open: 15, fixed: 5, ...}"
    )
    with_exploit: int = Field(0, description="Con exploit disponible")
    average_cvss: float = Field(0.0, description="Promedio CVSS")
    open_count: int = Field(0, description="Vulnerabilidades abiertas")
    resolved_count: int = Field(0, description="Vulnerabilidades resueltas")
    false_positive_count: int = Field(0, description="Falsos positivos")


class VulnerabilityBulkUpdate(BaseSchema):
    """Schema para actualización masiva de vulnerabilidades."""
    
    vulnerability_ids: list[str] = Field(..., min_length=1, max_length=100)
    status: Optional[str] = None
    assigned_to_id: Optional[str] = None
    due_date: Optional[datetime] = None


class VulnerabilityFilter(BaseSchema):
    """Filtros para búsqueda de vulnerabilidades."""
    
    severity: Optional[list[str]] = None
    status: Optional[list[str]] = None
    asset_id: Optional[str] = None
    service_id: Optional[str] = None
    scan_id: Optional[str] = None
    cve_id: Optional[str] = None
    exploit_available: Optional[bool] = None
    assigned_to_id: Optional[str] = None
    search: Optional[str] = Field(None, description="Buscar en nombre y descripción")
    min_cvss: Optional[float] = Field(None, ge=0.0, le=10.0)
    max_cvss: Optional[float] = Field(None, ge=0.0, le=10.0)
    date_from: Optional[datetime] = None
    date_to: Optional[datetime] = None
