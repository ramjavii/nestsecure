'use client';

import { useState } from 'react';
import { Search, Filter, X, RotateCw } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Slider } from '@/components/ui/slider';
import { Switch } from '@/components/ui/switch';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Badge } from '@/components/ui/badge';
import type { CVESearchParams, CVESeverity } from '@/types';

interface CVESearchFormProps {
  initialParams?: CVESearchParams;
  onSearch: (params: CVESearchParams) => void;
  onReset?: () => void;
  isLoading?: boolean;
  compact?: boolean;
}

const severityOptions: { value: CVESeverity; label: string }[] = [
  { value: 'CRITICAL', label: 'Critical' },
  { value: 'HIGH', label: 'High' },
  { value: 'MEDIUM', label: 'Medium' },
  { value: 'LOW', label: 'Low' },
  { value: 'NONE', label: 'None' },
];

export function CVESearchForm({
  initialParams = {},
  onSearch,
  onReset,
  isLoading,
  compact = false,
}: CVESearchFormProps) {
  const [search, setSearch] = useState(initialParams.search || '');
  const [severity, setSeverity] = useState<CVESeverity | undefined>(initialParams.severity);
  const [cvssRange, setCvssRange] = useState<[number, number]>([
    initialParams.min_cvss || 0,
    initialParams.max_cvss || 10,
  ]);
  const [hasExploit, setHasExploit] = useState(initialParams.has_exploit || false);
  const [inCisaKev, setInCisaKev] = useState(initialParams.in_cisa_kev || false);
  const [vendor, setVendor] = useState(initialParams.vendor || '');
  const [product, setProduct] = useState(initialParams.product || '');
  const [isFiltersOpen, setIsFiltersOpen] = useState(false);

  const activeFiltersCount = [
    severity,
    cvssRange[0] > 0 || cvssRange[1] < 10,
    hasExploit,
    inCisaKev,
    vendor,
    product,
  ].filter(Boolean).length;

  const handleSubmit = (e?: React.FormEvent) => {
    e?.preventDefault();
    
    const params: CVESearchParams = {};
    
    if (search.trim()) params.search = search.trim();
    if (severity) params.severity = severity;
    if (cvssRange[0] > 0) params.min_cvss = cvssRange[0];
    if (cvssRange[1] < 10) params.max_cvss = cvssRange[1];
    if (hasExploit) params.has_exploit = true;
    if (inCisaKev) params.in_cisa_kev = true;
    if (vendor.trim()) params.vendor = vendor.trim();
    if (product.trim()) params.product = product.trim();
    
    onSearch(params);
  };

  const handleReset = () => {
    setSearch('');
    setSeverity(undefined);
    setCvssRange([0, 10]);
    setHasExploit(false);
    setInCisaKev(false);
    setVendor('');
    setProduct('');
    onReset?.();
    onSearch({});
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      handleSubmit();
    }
  };

  if (compact) {
    return (
      <div className="flex items-center gap-2">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search CVE ID, keyword, vendor..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            onKeyDown={handleKeyDown}
            className="pl-10"
          />
        </div>
        <Popover open={isFiltersOpen} onOpenChange={setIsFiltersOpen}>
          <PopoverTrigger asChild>
            <Button variant="outline" className="relative">
              <Filter className="h-4 w-4 mr-2" />
              Filters
              {activeFiltersCount > 0 && (
                <Badge
                  variant="secondary"
                  className="absolute -top-2 -right-2 h-5 w-5 p-0 flex items-center justify-center text-xs"
                >
                  {activeFiltersCount}
                </Badge>
              )}
            </Button>
          </PopoverTrigger>
          <PopoverContent className="w-80" align="end">
            <div className="space-y-4">
              <div className="space-y-2">
                <Label>Severity</Label>
                <Select
                  value={severity || ''}
                  onValueChange={(v) => setSeverity(v as CVESeverity || undefined)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="All severities" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="">All</SelectItem>
                    {severityOptions.map((opt) => (
                      <SelectItem key={opt.value} value={opt.value}>
                        {opt.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label>CVSS Score: {cvssRange[0]} - {cvssRange[1]}</Label>
                <Slider
                  min={0}
                  max={10}
                  step={0.1}
                  value={cvssRange}
                  onValueChange={(v) => setCvssRange(v as [number, number])}
                  className="mt-2"
                />
              </div>

              <div className="flex items-center justify-between">
                <Label htmlFor="exploit">Has Exploit</Label>
                <Switch
                  id="exploit"
                  checked={hasExploit}
                  onCheckedChange={setHasExploit}
                />
              </div>

              <div className="flex items-center justify-between">
                <Label htmlFor="kev">In CISA KEV</Label>
                <Switch
                  id="kev"
                  checked={inCisaKev}
                  onCheckedChange={setInCisaKev}
                />
              </div>

              <div className="space-y-2">
                <Label>Vendor</Label>
                <Input
                  placeholder="e.g., apache, microsoft"
                  value={vendor}
                  onChange={(e) => setVendor(e.target.value)}
                />
              </div>

              <div className="space-y-2">
                <Label>Product</Label>
                <Input
                  placeholder="e.g., log4j, windows"
                  value={product}
                  onChange={(e) => setProduct(e.target.value)}
                />
              </div>

              <div className="flex gap-2 pt-2">
                <Button onClick={() => { handleSubmit(); setIsFiltersOpen(false); }} className="flex-1">
                  Apply Filters
                </Button>
                <Button variant="outline" onClick={handleReset}>
                  <RotateCw className="h-4 w-4" />
                </Button>
              </div>
            </div>
          </PopoverContent>
        </Popover>
        <Button onClick={() => handleSubmit()} disabled={isLoading}>
          <Search className="h-4 w-4 mr-2" />
          Search
        </Button>
      </div>
    );
  }

  // Full form layout
  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="flex gap-4">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search CVE ID, keyword, description..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10"
          />
        </div>
        <Button type="submit" disabled={isLoading}>
          {isLoading ? (
            <RotateCw className="h-4 w-4 mr-2 animate-spin" />
          ) : (
            <Search className="h-4 w-4 mr-2" />
          )}
          Search
        </Button>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
        <div className="space-y-2">
          <Label>Severity</Label>
          <Select
            value={severity || ''}
            onValueChange={(v) => setSeverity(v as CVESeverity || undefined)}
          >
            <SelectTrigger>
              <SelectValue placeholder="All" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="">All</SelectItem>
              {severityOptions.map((opt) => (
                <SelectItem key={opt.value} value={opt.value}>
                  {opt.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        <div className="space-y-2">
          <Label>Min CVSS</Label>
          <Input
            type="number"
            min={0}
            max={10}
            step={0.1}
            value={cvssRange[0]}
            onChange={(e) => setCvssRange([parseFloat(e.target.value) || 0, cvssRange[1]])}
          />
        </div>

        <div className="space-y-2">
          <Label>Max CVSS</Label>
          <Input
            type="number"
            min={0}
            max={10}
            step={0.1}
            value={cvssRange[1]}
            onChange={(e) => setCvssRange([cvssRange[0], parseFloat(e.target.value) || 10])}
          />
        </div>

        <div className="space-y-2">
          <Label>Vendor</Label>
          <Input
            placeholder="e.g., apache"
            value={vendor}
            onChange={(e) => setVendor(e.target.value)}
          />
        </div>

        <div className="space-y-2">
          <Label>Product</Label>
          <Input
            placeholder="e.g., log4j"
            value={product}
            onChange={(e) => setProduct(e.target.value)}
          />
        </div>

        <div className="flex items-end gap-4">
          <div className="flex items-center gap-2">
            <Switch
              id="exploit-full"
              checked={hasExploit}
              onCheckedChange={setHasExploit}
            />
            <Label htmlFor="exploit-full" className="text-sm">Exploit</Label>
          </div>
          <div className="flex items-center gap-2">
            <Switch
              id="kev-full"
              checked={inCisaKev}
              onCheckedChange={setInCisaKev}
            />
            <Label htmlFor="kev-full" className="text-sm">KEV</Label>
          </div>
        </div>
      </div>

      {activeFiltersCount > 0 && (
        <div className="flex items-center gap-2">
          <span className="text-sm text-muted-foreground">Active filters:</span>
          {severity && (
            <Badge variant="secondary" className="gap-1">
              {severity}
              <X
                className="h-3 w-3 cursor-pointer"
                onClick={() => setSeverity(undefined)}
              />
            </Badge>
          )}
          {(cvssRange[0] > 0 || cvssRange[1] < 10) && (
            <Badge variant="secondary" className="gap-1">
              CVSS: {cvssRange[0]}-{cvssRange[1]}
              <X
                className="h-3 w-3 cursor-pointer"
                onClick={() => setCvssRange([0, 10])}
              />
            </Badge>
          )}
          {hasExploit && (
            <Badge variant="secondary" className="gap-1">
              Has Exploit
              <X
                className="h-3 w-3 cursor-pointer"
                onClick={() => setHasExploit(false)}
              />
            </Badge>
          )}
          {inCisaKev && (
            <Badge variant="secondary" className="gap-1">
              In KEV
              <X
                className="h-3 w-3 cursor-pointer"
                onClick={() => setInCisaKev(false)}
              />
            </Badge>
          )}
          {vendor && (
            <Badge variant="secondary" className="gap-1">
              Vendor: {vendor}
              <X className="h-3 w-3 cursor-pointer" onClick={() => setVendor('')} />
            </Badge>
          )}
          {product && (
            <Badge variant="secondary" className="gap-1">
              Product: {product}
              <X className="h-3 w-3 cursor-pointer" onClick={() => setProduct('')} />
            </Badge>
          )}
          <Button variant="ghost" size="sm" onClick={handleReset}>
            Clear all
          </Button>
        </div>
      )}
    </form>
  );
}

export default CVESearchForm;
